"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.prepare = void 0;
const logger_1 = require("./util/logger");
const config_1 = require("./config");
const KnexMigrationSource_1 = require("./migration/KnexMigrationSource");
const knexMigrator_1 = require("./migration/service/knexMigrator");
/**
 * Prepare configurations, preload requirements and validate before proceeding further.
 *
 * @param {Configuration} config
 * @param {PrepareOptions} options
 * @returns {Promise<PreparedRequirements>}
 */
async function prepare(config, options) {
    (0, logger_1.log)('Prepare: ', options);
    // Validate the config for programmatic API access.
    // CLI access validates the config while loading, for programmatic access it should be done here.
    if (!(0, config_1.isCLI)()) {
        (0, config_1.validate)(config);
    }
    const migrationContext = await (0, knexMigrator_1.resolveMigrationContext)(config, options);
    return {
        knexMigrationConfig: (connectionId) => ({
            tableName: config.migration.tableName,
            migrationSource: migrationContext ? new KnexMigrationSource_1.default(migrationContext.bind(connectionId)) : undefined
        })
    };
}
exports.prepare = prepare;
